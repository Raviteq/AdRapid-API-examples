<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../assets/app.css">
    <title>Drafts</title>
  </head>
  <body>
    <!-- main content-->
    <div id="app" class="content">
      <div id="templates">
        <div id="description">
          <h3>Drafts example</h3>
          <p>This is an example showcasing how handling of drafts can be implemented. To acheive this, we need a mechanism to store and retreive the form data. For this example we simple save the form data in the browser using <code>localStorage</code>, but any other mechanism (for example using a database) will work in the same way. </p>
          <p>Since we are using the html5 live preview, we only need to change the form fields to trigger an update of the preview.</p>
        </div>
      </div>
      <div id="form">
      </div>
      <div id="results">
        <div id="target">
          <h3>Preview</h3>
        </div>
      </div>
    </div>
    <div id="spinner" class="loader">
      <div class="throbber throbber_large"></div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="../assets/adrapid.js"></script>
    <script src="../assets/helpers.js"></script>
    <script type="text/javascript">
      /*
       * Drafts example - load and save drafts data.
       * In this example we are using localStorage, but we could use for
       * example a database for saving the data.
       */
      
      var api_key = '6271f323ff24875b74569ebc76eafa7c8ce0aa85';
      var template_key = 'fa1634c5f3e7aefc5cd5db1bdcc1e44d0e38bab8';
      var adrapid = new AdRapid(api_key);
      
      function getDraft(event) {
        event.preventDefault();
      
        console.log('Loading draft');
        console.log(localStorage.getItem('draft'));
      
        // iterate over draft data, change form fields to our saved data
        $.each(JSON.parse(localStorage.getItem('draft')), function(key, val) {
          $('input[name=' + key + ']')
            .val(val) // set the value of the form field
            .trigger('input'); // trigger update of the form field 
          console.log('Setting ' + key + ' => ' + val);
        });
      
      }
      
      function saveDraft(event) {
        event.preventDefault();
        console.log('Saving draft');
      
        // concat the form data into a string
        var draft = JSON.stringify($('form#form').serializeObject());
      
        // saving draft data somewhere - in this case localhost
        localStorage.setItem('draft', draft);
      
      }
      
      // wrappwr function
      (function init() {
        
        // iniate a live preview for our template key 
        getLivePreview(template_key);
      
        // wrap the form in a form
        $('#form').wrap('<form id="form">');
      
        // move it 
        $("#form").detach().appendTo('#templates');
      
        // wait for a while to allow the
        setTimeout(function() {
          $('#form').prepend('<button id="load">Load draft</button>');
          $('#form').prepend('<button id="save">Save draft</button>');
          
          // setup events
          $('button#load').click(getDraft);
          $('button#save').click(saveDraft);
        }, 600);
      
      })();
      
      // set up live preview helper - available in preview example implementation
      function getLivePreview(template_key) {
        helpers.template_key = template_key;      // store template key in helpers object.. secret fix
        helpers.getForm(template_key);            // get the form for the template
        helpers.getLivePreview(template_key);     // get the live preview, bind form events
      }
    </script>
  </body>
</html>